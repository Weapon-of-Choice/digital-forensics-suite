upstream frontend {
    server frontend:3000;
}

upstream api {
    server api:8000;
}

upstream keycloak {
    server keycloak:8080;
}

upstream osm {
    server osm:3000;
}

upstream geocoder {
    server geocoder:5000;
}

upstream face_service {
    server face-service:5000;
}

upstream hash_service {
    server hash-service:5000;
}

upstream vsm_service {
    server vsm-service:5000;
}

upstream ai_categorizer {
    server ai-categorizer:5000;
}

upstream flower {
    server flower:5555;
}

upstream minio_console {
    server minio:9001;
}

upstream minio_api {
    server minio:9000;
}

server {
    listen 80;
    server_name localhost;
    client_max_body_size 500M;

    # Frontend (React app)
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Main API
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Keycloak authentication
    location /auth/ {
        proxy_pass http://keycloak;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # OpenStreetMap Next.js app
    location /osm/ {
        rewrite ^/osm/(.*) /$1 break;
        proxy_pass http://osm;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Geocoder service
    location /geocoder/ {
        rewrite ^/geocoder/(.*) /$1 break;
        proxy_pass http://geocoder;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Face recognition service (internal, but exposed for debugging)
    location /services/face/ {
        rewrite ^/services/face/(.*) /$1 break;
        proxy_pass http://face_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 120s;
    }

    # Hash service (internal, but exposed for debugging)
    location /services/hash/ {
        rewrite ^/services/hash/(.*) /$1 break;
        proxy_pass http://hash_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Video Signature Matching service
    location /services/vsm/ {
        rewrite ^/services/vsm/(.*) /$1 break;
        proxy_pass http://vsm_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300s;
    }

    # AI Categorizer service
    location /services/ai/ {
        rewrite ^/services/ai/(.*) /$1 break;
        proxy_pass http://ai_categorizer;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 120s;
    }

    # Media files
    location /media/ {
        proxy_pass http://api/media/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health checks
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # Flower (Celery monitoring)
    location /flower/ {
        rewrite ^/flower/(.*) /$1 break;
        proxy_pass http://flower;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_redirect off;
    }

    # MinIO Console (Storage Management)
    location /minio/ {
        rewrite ^/minio/(.*) /$1 break;
        proxy_pass http://minio_console;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-NginX-Proxy true;
        proxy_ssl_session_reuse off;
        proxy_redirect off;
        proxy_buffering off;
    }

    # MinIO S3 API (for presigned URLs)
    location /s3/ {
        rewrite ^/s3/(.*) /$1 break;
        proxy_pass http://minio_api;
        proxy_set_header Host minio:9000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 300;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
    }
}
